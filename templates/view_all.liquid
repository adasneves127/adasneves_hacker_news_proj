<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Data</title>
    <script>
      function filterData() {

// Do refresh with URL parameters.
        const lSalary = document.getElementById("lSalary").value;
        const hSalary = document.getElementById("hSalary").value;
        const isRemote = document.getElementById("isRemote").checked;
        const raw_unix_date_after = + new Date(document.getElementById("posted_on").value)
        const str_date_after = String(!isNaN(raw_unix_date_after) ? raw_unix_date_after : "" );
        const post_after = str_date_after.slice(0, 10);

        const raw_unix_date_before = + new Date(document.getElementById("posted_before").value)
        const str_date_before = String(!isNaN(raw_unix_date_before) ? raw_unix_date_before : "" );
        const post_before = str_date_before.slice(0, 10);

        const keyword_text = document.getElementById('keywords').value

        let url = `http://localhost:5000/view?lSalary=${lSalary}&hSalary=${hSalary}&isRemote=${isRemote}&keywords=${keyword_text}`;
        if (!isNaN(post_after)) {
          url += `&post_by=${post_after}`;
        }
      
        if (!isNaN(post_before)) {
          url += `&post_before=${post_before}`;
        }
      window.location.href = url;
    }

    function load_boxes() {

// Load the filters from the URL parameters.
      const urlParams = new URLSearchParams(window.location.search);
      const lSalary = urlParams.get('lSalary');
      const hSalary = urlParams.get('hSalary');
      const keywords = urlParams.get('keywords');
      const isRemote = (urlParams.get('isRemote') === 'true');

      document.getElementById("lSalary").value = lSalary;
      document.getElementById("hSalary").value = hSalary;
      document.getElementById("isRemote").checked = isRemote;
      document.getElementById("keywords").value = keywords;


      let date_after = new Date(parseInt(urlParams.get('post_by')) * 1000);
      document.getElementById("posted_on").value = date_after.toISOString().split('T')[0]

      let date_before = new Date(parseInt(urlParams.get('post_before')) * 1000);
      if(parseInt(urlParams.get('post_before')) == 0){
        document.getElementById("posted_before").value = new Date().toISOString().split('T')[0]
      } else {
        document.getElementById("posted_before").value = date_before.toISOString().split('T')[0]
      }
    }
    </script>
    <style>
      /* *{
        outline: 1px solid green;
      } */
      table,
      th,
      td {
        border-collapse: collapse;
        border: 1px solid;
      }
      #dataFilters{
        width: 48%
      }
      #fieldBoxes{
        height: 20dvh;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body onload="load_boxes()">
    <button onclick="window.location.href='/'">Back</button>
    <div id="fieldBoxes">
      <fieldset id="dataFilters">
        <legend>Filters</legend>
        <label for="lSalary">Low Salary &gt;</label>
        <input
          type="number"
          name="lSalary"
          id="lSalary"> <br>
        <label for="hSalary">High Salary &lt;</label>
        <input
          type="number"
          name="hSalary"
          id="hSalary">
        <br>
        <label for="isRemote">Show Remote</label>
        <input
          type="checkbox"
          name="isRemote"
          id="isRemote">
        <br/>
        <!-- Posted on or after -->
        <label for="posted_on">Posted After</label>
        <input
          type="date"
          name="posted_on"
          id="posted_on">
        <br>

        <!-- Posted on or before -->
        <label for="posted_before">Posted Before</label>
        <input
          type="date"
          name="posted_before"
          id="posted_before">
        <br>

        <!-- Keywords -->
        <label for="keywords">Search Terms (Seperate by comma)</label>
        <input type="text" name="keywords" id="keywords">
        <br>

        <button onclick="filterData()">Filter</button>
      </fieldset>
      
    </div>

    <table>
      <tr>
        <th>Company Name</th>
        <th>Location</th>
        <th>Date Posted</th>
        <th>View</th>
      </tr>
      {% for row in data %}
        <tr>
          <td>{{ row[0] }}</td>
          <td>{{ row[1] }}</td>
          <td>{{ row[2] }}</td>
          <td>
            <a href="/expand/{{row[3]}}">View</a>
          </td>
        </tr>
      {% endfor %}
    </table>
  </body>

</html>